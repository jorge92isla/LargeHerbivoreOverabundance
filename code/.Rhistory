units = "percentage_in_track")
# Verificar los primeros valores para confirmar
head(track_cover_clean_data)
View(track_cover_clean_data)
str(track_cover_clean_data)
track_cover_clean_data %>%
filter(level == "Bare_ground") %>%
summarise(
Min = min(observation, na.rm = TRUE),
Max = max(observation, na.rm = TRUE),
Media = mean(observation, na.rm = TRUE),
Mediana = median(observation, na.rm = TRUE),
Desviacion = sd(observation, na.rm = TRUE)
) %>%
mutate(across(everything(), round, 2))
scrub_height <- leñosas_raw_data %>%
select(-c(`Taxon`, `Variable ini`, `Variable fin`, `Intervalo`, `Grado de ramoneo:`)) %>%
mutate(
site = site,
habitat = habitat,
treatment = treatment,
variable_name = "scrub_height",
level = NA,
observation = NA,
units = "vegetation height (cm)",
comments = NA,      # Columna vacía 'comments'
author_code = NA    # Columna vacía 'author_code'
)
# Eliminar las filas duplicadas
scrub_height <- distinct(scrub_height)
library(dplyr)
library(tidyr)
scrub_height2 <- scrub_height %>%
pivot_longer(
cols = matches("^[0-9]+m$"),        # columnas como 6m, 12m, etc.
names_to = "height_level",          # nuevo nombre para evitar conflicto con "plot"
values_to = "height_observation"    # nuevo nombre para evitar conflicto con "observation"
) %>%
select(
site,
habitat,
treatment,
height_level,         # esto reemplaza a los nombres tipo 6m, 12m, etc.
sampling_unit,
year,
date,
variable_type,
variable_name,
level,
height_observation,   # esto contiene el valor de altura
units,
comments,
author_code
)
# Eliminar las filas duplicadas
scrub_height2 <- distinct(scrub_height2)
# Ver los primeros registros para asegurarse de que todo está correcto
head(scrub_height2)
#Esto también me veo obligado a hacerlo nuevo, imputar scrub a los NA de valencia en habitat, no hace nada en el análisis, pero me ayuda después..
scrub_height2 <- scrub_height2 %>%
mutate(habitat = ifelse(is.na(habitat), "scrub", habitat))
min(scrub_height2$height_observation)
max(scrub_height2$height_observation)
mean(max(scrub_height2$height_observation))
mean(scrub_height2$height_observation)
median(scrub_height2$height_observation)
sd(scrub_height2$height_observation)
# Cargar las librerías necesarias
library(readr)
library(tidyverse)
library(dplyr)
library(vegan)
library(ggforce)
# Cargar el archivo de datos
ticks <- read_csv("~/Documents/GitHub/PAELLALAB/INCREMENTO/data_prepared/ticks_clean_data.csv")
ticks
View(ticks)
# Crear la nueva columna con la combinación de site, treatment, sampling_unit y year
ticks$new_column <- paste(ticks$site, ticks$treatment, ticks$sampling_unit, ticks$year, sep = "/")
ticks_summary <- ticks %>%
group_by(new_column) %>%
summarise(mean_observation = mean(observation, na.rm = TRUE), .groups = 'drop') %>%
right_join(ticks, by = "new_column")
ticks_summary
# Ver el resultado
head(ticks_summary)
# Eliminar las columnas new_column, observation y date
ticks_summary <- ticks_summary %>%
select(-new_column, -observation, -date)
ticks_summary <- ticks_summary %>%
distinct()
# Cambiar el nombre de la columna total_observation a observation
ticks_summary <- ticks_summary %>%
rename(observation = mean_observation)
ticks_summary
View(ticks_summary)
# Cargar las librerías necesarias
library(readr)
library(tidyverse)
library(dplyr)
library(vegan)
library(ggforce)
# Cargar el archivo de datos
ticks <- read_csv("~/Documents/GitHub/PAELLALAB/INCREMENTO/data_prepared/ticks_clean_data.csv")
names(ticks)
# Crear la nueva columna con la combinación de site, treatment, sampling_unit y year
ticks$new_column <- paste(ticks$site, ticks$treatment, ticks$sampling_unit, ticks$year, sep = "/")
ticks_summary <- ticks %>%
group_by(new_column) %>%
summarise(mean_observation = mean(observation, na.rm = TRUE), .groups = 'drop') %>%
right_join(ticks, by = "new_column")
# Ver el resultado
head(ticks_summary)
# Eliminar las columnas new_column, observation y date
ticks_summary <- ticks_summary %>%
select(-new_column, -observation, -date)
ticks_summary <- ticks_summary %>%
distinct()
# Cambiar el nombre de la columna total_observation a observation
ticks_summary <- ticks_summary %>%
rename(observation = mean_observation)
ticks_summary
max(ticks_summary$observation)
mean(ticks_summary$observation)
median(ticks_summary$observation)
sd(ticks_summary$observation)
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(dplyr)
library(tidyr)
library(stringr)
getwd()
teabag <- read_excel("/Users/jorgeislaescudero/Documents/GitHub/PAELLALAB/INCREMENTO/data_raw/biotic_soil/TeaBagINCREMENTO.xlsx",
sheet = "all")
head(teabag)
teabag<-teabag %>%
mutate(
site = case_when(
site == "MC" ~ "valencia",
site == "QM" ~ "toledo",
TRUE ~ site
),
track = paste0("T", track),
treatment = tolower(treatment),
habitat = tolower(habitat),
treatment = case_when(
treatment == "control a" ~ "control_high",
treatment == "control b" ~ "control_hyper",
TRUE ~ treatment
)
)
View(teabag)
min(teabag$s)
max(teabag$s)
mean(teabag$s)
median(teabag$s)
sd(teabag$s)
min(teabag$k)
mean(teabag$k)
mean(teabag$k, na.action(omit))
mean(teabag$k, na.rm = TRUE)
median(teabag$k, na.rm = TRUE)
sd(teabag$k, na.rm = TRUE)
densidad_aparente <- read_excel(file.path("~/Documents/GitHub/PAELLALAB/INCREMENTO/data_raw/abiotic_soil/ADensity Global.xlsx"))
str(densidad_aparente)
# Aplicar transformaciones al dataset
densidad_aparente_data <- densidad_aparente %>%
# Renombrar y modificar la columna "Zona"
mutate(
site = case_when(
Zona == "QM" ~ "toledo",
Zona == "MC" ~ "valencia",
TRUE ~ Zona
),
habitat = tolower(habitat),  # Convertir "habitat" a minúsculas
treatment = tolower(Treatment),  # Convertir "Treatment" a "treatment" en minúsculas
plot = as.numeric(str_extract(`sampling point`, "(?<=S)\\d+(?=-)")),  # Extraer número entre "S" y "-"
sampling_unit = as.numeric(str_extract(`sampling point`, "(?<=-)\\d+")),  # Extraer número después de "-"
year = case_when(
time == "3Months" ~ "2021",
time == "1Year" ~ "2022",
TRUE ~ NA_character_
),
date = NA_character_,  # Columna vacía
variable_type = "soil",
variable_name = "apparent_density",
level = NA_character_,  # Columna vacía
observation = `AD(g/cm3)`,  # Copiar valores de "AD(g/cm3)"
units = "AD(g/cm3)",
comments = NA_character_,  # Columna vacía
author_code = NA_character_  # Columna vacía
) %>%
# Seleccionar y reordenar las columnas según lo solicitado
select(
site, habitat, treatment, plot, sampling_unit, year, date,
variable_type, variable_name, level, observation, units,
comments, author_code
)
# Ver el resultado
head(densidad_aparente_data)
View(densidad_aparente_data)
mean(densidad_aparente_data$observation)
median(densidad_aparente_data$observation)
sd(densidad_aparente_data$observation)
my_main_model_vector <- rma.mv(yi = delta_lnrr_inverted,
V = delta_var,
mods = ~ type + tratamiento + sei ,  # Efectos fijos principales
random = list(~ 1 | grupo,
~ 1 | site,
~ 1 | EffectID),
method = "REML",
test = "t",
data = my_data,
slab = grupo)
library(orchaRd)
library(here)
library(knitr)
library(revtools)
library(synthesisr)
library(tidyverse)
library(metafor)
#library(ggstatsplot)
library(gridExtra)
library(metaDigitise)
library(ape)
library(rotl)
library(ggpubr)
library(cowplot)
library(lme4)
library(lmerTest)
library(readr)
library(dplyr)
library(tidyr)
library(gt)
library(ggplot2)
library(tidyverse)
library(ggthemes)
library(readxl)
#meta_data <- read_csv("~/Documents/GitHub/PAELLALAB/INCREMENTO/data_prepared/toy_example_curse.csv")
my_data   <-read_csv("~/Documents/GitHub/PAELLALAB/INCREMENTO/results/datos_combinados.csv")
# Reemplazar NAs en columnas específicas
my_data <- my_data %>%
mutate(
variable = case_when(
is.na(variable) & grupo == "raton" ~ "abundance",
is.na(variable) & grupo == "suelo" ~ "density",
TRUE ~ variable
),
type = if_else(is.na(type), "funcionalidad", type)
)
## transform characters to factors
#cols.factors <- colnames(meta_data)[as.vector(sapply(meta_data, class)=="character")]
#meta_data[cols.factors] <- lapply(meta_data[cols.factors], factor)
#sapply(meta_data, class)
# Crear la columna sign_factor basada en nuestras decisiones
my_data$sign_factor <- case_when(
my_data$variable2 == "ants_Richness" ~ 1,
my_data$variable2 == "ants_Diversity" ~ 1,
my_data$variable2 == "ants_Abundance" ~ 1,
my_data$variable2 == "aves_Richness" ~ 1,
my_data$variable2 == "aves_Diversity" ~ 1,
my_data$variable2 == "aves_Abundance" ~ 1,
my_data$variable2 == "browsing_Browsing CWMb" ~ -1,
my_data$variable2 == "ecofisiologica_Anthocyanin" ~ -1,
my_data$variable2 == "ecofisiologica_Chlorophyll" ~ 1,
my_data$variable2 == "fruitset_C.ladanifer (low palatability)" ~ 1,
my_data$variable2 == "fruitset_Fruit Set C.populifolius (high palatability)" ~ 1,
my_data$variable2 == "garrapatas_Ticks Abundance" ~ -1,
my_data$variable2 == "habitatcomposition_Bare ground" ~ -1,
my_data$variable2 == "habitatcomposition_Vegetation Height" ~ -1,
my_data$variable2 == "herbáceas_Richness" ~ 1,
my_data$variable2 == "herbáceas_Diversity" ~ 1,
my_data$variable2 == "herbáceas_Abundance" ~ 1,
my_data$variable2 == "invertebrates_Richness" ~ 1,
my_data$variable2 == "invertebrates_Diversity" ~ 1,
my_data$variable2 == "invertebrates_Abundance" ~ 1,
my_data$variable2 == "leñosas_Richness" ~ 1,
my_data$variable2 == "leñosas_Diversity" ~ 1,
my_data$variable2 == "leñosas_Abundance" ~ 1,
my_data$variable2 == "networks_Weighted Connectance" ~ 1,
my_data$variable2 == "networks_Interaction Evenness" ~ 1,
my_data$variable2 == "networks_Modularity" ~ 1,
my_data$variable2 == "networks_Interaction Richness" ~ 1,
my_data$variable2 == "networks_Pollinator Richness" ~ 1,
my_data$variable2 == "networks_Flowering Species Richnes" ~ 1,
my_data$variable2 == "raton_NA" ~ 1,
my_data$variable2 == "regeneracion_Abundance" ~ 1,
my_data$variable2 == "regeneracion_Richness" ~ 1,
my_data$variable2 == "regeneracion_Diversity" ~ 1,
my_data$variable2 == "sizespectrum_Invertebrate Biomass" ~ 1,
my_data$variable2 == "sizespectrum_Trophic efficiency" ~ 1,
my_data$variable2 == "suelo_NA" ~ -1,
my_data$variable2 == "teabags_Organic material stabilization (S)" ~ 1,
my_data$variable2 == "teabags_Organic material decomposition (K)" ~ 1,
TRUE ~ 1  # Por defecto 1 por si falta alguna
)
# Crear la variable invertida
my_data$delta_lnrr_inverted <- my_data$delta_lnrr * my_data$sign_factor
# transform characters to factors
cols.factors <- colnames(my_data)[as.vector(sapply(my_data, class)=="character")]
my_data[cols.factors] <- lapply(my_data[cols.factors], factor)
sapply(my_data, class)
#meta_data$EffectID <- 1:nrow(meta_data)
my_data$EffectID   <- 1:nrow(my_data)
#forest(meta_data$Zr, meta_data$VZr)
forest(my_data$delta_lnrr, my_data$delta_var)
forest(my_data$delta_lnrr_inverted, my_data$delta_var)
intercept_only_model<- rma.mv(yi = delta_lnrr_inverted,
V = delta_var,
mods = ~  1,  # Sin moderadores
random = list(~ 1 | grupo,
~ 1 | EffectID),
method = "REML",
test = "t",
data = my_data,
slab = grupo)
## Printing the summary results of the model
print(intercept_only_model, digits = 3)
forest(intercept_only_model,
addpred=TRUE,
xlim=c(-5,5),
at=seq(-4.5,4.5,by=0.5),
shade="zebra",
cex=0.6,
header="Group of variables")
results_intercept_only_model_vector <- mod_results(intercept_only_model,
mod = "1",
at = NULL, group = "grupo")
orchaRd::caterpillars(results_intercept_only_model_vector,
mod = "1",
xlab = "grupo")
# Model funnel plots
funnel(intercept_only_model)
sigma2_v <- function(mod){
sigma2_v <- sum(1 / mod$vi) * (mod$k - 1) /
(sum(1 / mod$vi)^2 - sum((1 / mod$vi)^2))
return(sigma2_v)
}
sigma2_v(intercept_only_model)
# # Total unstandardized raw variance (i.e. total heterogeneity)
sigma2_intercept_only_model <- sum(intercept_only_model$sigma2)
I2_intercept_only_model <- orchaRd::i2_ml(intercept_only_model)
CV_intercept_only_model <- orchaRd::cvh2_ml(intercept_only_model)
M_intercept_only_model <- orchaRd::m2_ml(intercept_only_model)
sigma2_intercept_only_model
I2_intercept_only_model
CV_intercept_only_model
M_intercept_only_model
my_data$sei <- sqrt(my_data$delta_var) # SE = sqrt(SV)
my_sei_model_vector <- rma.mv(yi = delta_lnrr_inverted,
V = delta_var,
mods = ~ 1 + sei,  # Incluyendo el standard error como moderador
random = list(~ 1 | grupo,
~ 1 | EffectID),
method = "REML",
test = "t",
data = my_data)
# Printing the summary results of the model
print(my_sei_model_vector, digits = 3)
figure_small_study_effects <- orchaRd::bubble_plot(my_sei_model_vector,
mod = "sei",
group = "grupo",
xlab = "sei",
legend.pos = "bottom.right")
figure_small_study_effects
round(r2_ml(my_sei_model_vector)*100, 2)[1]
my_treatment_model_vector <- rma.mv(yi = delta_lnrr_inverted,
V = delta_var,
mods = ~ 1 + tratamiento, # Incluyendo tratamiento como
random = list(~ 1 | grupo,
~ 1 | EffectID),
method = "REML",
test = "t",
data = my_data,
slab = variable2)
print(my_treatment_model_vector)
fig_tratamiento <- orchaRd::orchard_plot(my_treatment_model_vector,
mod = "tratamiento",
group = "grupo",
xlab = "Effect size",
transfm = "tanh",
trunk.size = 1.5,
branch.size = 3,
twig.size = 1)
fig_tratamiento <- fig_tratamiento +
ggplot2::scale_fill_manual(values = c("High" = "#E3626F", "Hyper" = "#424242")) +
ggplot2::scale_colour_manual(values = c("High" = "white", "Hyper" = "white")) +
ggplot2::scale_x_discrete(labels = c("High" = "High", "Hyper" = "Hyper")) +
ggplot2::labs(
title = "Large Herbivore Overabundance Density Treatment Effects",
caption = "Note: Effect sizes displayed with hyperbolic tangent transformation for improved visualization"
) +
ggplot2::theme(
plot.caption = element_text(size = 9, color = "gray40", hjust = 0)
)
fig_tratamiento
my_site_model_vector <- rma.mv(yi = delta_lnrr_inverted,
V = delta_var,
mods = ~ 1 + site, # Incluyendo site como
random = list(~ 1 | grupo,
~ 1 | EffectID),
method = "REML",
test = "t",
data = my_data,
slab = variable2)
print(my_site_model_vector)
fig_sitio <- orchaRd::orchard_plot(my_site_model_vector,
mod = "site",
group = "grupo",
xlab = "Effect size",
transfm = "tanh",
trunk.size = 1.5,
branch.size = 3,
twig.size = 1)
fig_sitio <- fig_sitio +
ggplot2::scale_x_discrete(labels = c("Valencia" = "Muela de Cortes", "Toledo" = "Quntos de Mora")) +
ggplot2::labs(
title = "Large Herbivore Overabundance Site Effects",
caption = "Note: Effect sizes displayed with hyperbolic tangent transformation for improved visualization") +
ggplot2::theme(plot.caption = element_text(size = 9, color = "gray40", hjust = 0))
fig_sitio
my_group_model_vector <- rma.mv(yi = delta_lnrr_inverted,
V = delta_var,
mods = ~ 1 + grupo, # Incluyendo site como
random = list(~ 1 | EffectID),
method = "REML",
test = "t",
data = my_data,
slab = variable2)
print(my_group_model_vector)
fig_grupo <- orchaRd::orchard_plot(my_group_model_vector,
mod = "grupo",
group = "grupo",
xlab = "Effect size",
transfm = "tanh",
trunk.size = 1,
branch.size = 1,
twig.size = 0.5)
fig_grupo <- fig_grupo +
ggplot2::labs(
title = "Large Herbivore Overabundance Group Effects",
caption = "Note: Effect sizes displayed with hyperbolic tangent transformation for improved visualization") +
ggplot2::theme(plot.caption = element_text(size = 9, color = "gray40", hjust = 0),
axis.text.y = element_text(angle = 0, hjust = 1, vjust = 1))  # ← Horizontal
fig_grupo
my_type_model_vector <- rma.mv(yi = delta_lnrr_inverted,
V = delta_var,
mods = ~ 1 + type, # Incluyendo site como
random = list(~ 1 | EffectID),
method = "REML",
test = "t",
data = my_data,
slab = variable2)
print(my_type_model_vector)
fig_type <- orchaRd::orchard_plot(my_type_model_vector,
mod = "type",
group = "grupo",
xlab = "Effect size",
transfm = "tanh",
trunk.size = 1.5,
branch.size = 3,
twig.size = 1)
fig_type <- fig_type +
ggplot2::scale_x_discrete(labels = c("Funcionalidad" = "Ecosystem functioning", "Diversidad" = "Species Diversity")) +
ggplot2::scale_fill_manual(values = c("Funcionalidad" = "#D85F02", "Diversidad" = "#45B599")) +
ggplot2::scale_colour_manual(values = c("High" = "white", "Hyper" = "white")) +
ggplot2::labs(
title = "Large Herbivore Overabundance Group Effects",
caption = "Note: Effect sizes displayed with hyperbolic tangent transformation for improved visualization") +
ggplot2::theme(plot.caption = element_text(size = 9, color = "gray40", hjust = 0))
fig_type
my_main_model_vector <- rma.mv(yi = delta_lnrr_inverted,
V = delta_var,
mods = ~ type + tratamiento + sei ,  # Efectos fijos principales
random = list(~ 1 | grupo,
~ 1 | site,
~ 1 | EffectID),
method = "REML",
test = "t",
data = my_data,
slab = grupo)
print(my_main_model_vector)
results_main_model_vector <- mod_results(my_main_model_vector,
mod = "1",
at = NULL, group = "variable2")
figure_main_model_vector <- orchaRd::orchard_plot(results_main_model_vector,
mod = "1",
group = "variable2",
xlab = "Effect size",
transfm = "tanh", # to plot r rather than Zr
trunk.size = 1.5,
branch.size = 3,
twig.size = 1)
# Transformaciones con ggplot
figure_main_model_vector.type<- figure_main_model_vector.type +
ggplot2::scale_x_discrete(labels = c("Funcionalidad" = "Ecosystem functioning", "Diversidad" = "Species Diversity")) +
ggplot2::scale_fill_manual(values = c("Funcionalidad" = "#D85F02", "Diversidad" = "#45B599")) +
ggplot2::scale_colour_manual(values = c("High" = "white", "Hyper" = "white")) +
ggplot2::theme(plot.caption = element_text(size = 9, color = "gray40", hjust = 0))
# Modificaciones incrustando estadísticos
figure_main_model_vector<-figure_main_model_vector + annotate(geom = "text", x = 1.5, y = -0.8, label = paste0("italic(sigma) == ",round(sigma2_main_model_vector,3)), color = "black", parse = TRUE, size = 4) + annotate(geom = "text", x = 1.4, y = -0.8, label = paste0("italic(I)^{2} == ",round(I2_main_model_vector[[1]],1), " *\"%\""), color = "black", parse = TRUE, size = 4) + annotate(geom = "text", x = 1.3, y = -0.8, label = paste0("italic(CV) == ",round(CV_main_model_vector[[1]],2)), color = "black", parse = TRUE, size = 4) + annotate(geom = "text", x = 1.2, y = -0.8, label = paste0("italic(M) == ",round(M_main_model_vector[[1]],2)), color = "black", parse = TRUE, size = 4)
figure_main_model_vector <- orchaRd::orchard_plot(results_main_model_vector,
mod = "1",
group = "variable2",
xlab = "Effect size",
transfm = "tanh", # to plot r rather than Zr
trunk.size = 1.5,
branch.size = 3,
twig.size = 1)
# Modificaciones incrustando estadísticos
figure_main_model_vector<-figure_main_model_vector + annotate(geom = "text", x = 1.5, y = -0.8, label = paste0("italic(sigma) == ",round(sigma2_main_model_vector,3)), color = "black", parse = TRUE, size = 4) + annotate(geom = "text", x = 1.4, y = -0.8, label = paste0("italic(I)^{2} == ",round(I2_main_model_vector[[1]],1), " *\"%\""), color = "black", parse = TRUE, size = 4) + annotate(geom = "text", x = 1.3, y = -0.8, label = paste0("italic(CV) == ",round(CV_main_model_vector[[1]],2)), color = "black", parse = TRUE, size = 4) + annotate(geom = "text", x = 1.2, y = -0.8, label = paste0("italic(M) == ",round(M_main_model_vector[[1]],2)), color = "black", parse = TRUE, size = 4)
figure_main_model_vector
