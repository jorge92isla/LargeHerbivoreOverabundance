---
title: "Code_1.9_data_carpintry_ticksmicromamiferos"
author: "Jorge"
date: "2025-03-12"
output: html_document
---
游 

Este es el dataset de carpinter칤a de datos para preparar los datos de **Micromam칤feros** que me env칤a Laura Fuentes Moyayo.


-   *Dimensi칩n temporal:* Los dos a침os
-   *Dimensi칩n espacial:* los dos sitios
-   *jorge_traductor* Laura fuentes me ha dajado la chuleta en el excel para hacer la interpretaci칩n de los datos


Cargando paquetes
```{r cargando paquetes, include=FALSE}
library(knitr)
library(readxl)
library(dplyr)
library(stringr)
library(lubridate)
```

Cargando datos
```{r}
micromammals_raw_data <- read_excel("~/Documents/GitHub/PAELLALAB/INCREMENTO/data_raw/ticks_micromamiferos/Raw data_Micromammals and ticks.xlsx", 
    sheet = "Micromammals")

colnames(micromammals_raw_data) <- micromammals_raw_data[1, ]  # Asigna la primera fila como nombres
micromammals_raw_data <- micromammals_raw_data[-1, ]  # Elimina la primera fila

# Ver estructura del dataset limpio
str(micromammals_raw_data)
```

Transformando los datos
```{r}
# Definir los nuevos nombres de columnas a agregar
 new_columns <- c("site", "habitat", "treatment", "plot", "sampling_unit", "year", 
                "date", "variable_type", "variable_name", 
                "units", "comments", "author_code")

# Agregar las nuevas columnas vac칤as al dataset
 micromammals_raw_data[new_columns] <- NA


# Modificar la nueva columna 'site' seg칰n los valores de 'Site'
 micromammals_raw_data <- micromammals_raw_data %>%
   mutate(site = case_when(
     Site == "MuelaC"  ~ "valencia",
     Site == "QuintosM" ~ "toledo",
     TRUE ~ NA_character_  # Deja NA si no coincide con los valores dados
   )) %>%
   select(-Site)  # Eliminar la antigua columna 'Site'

# Modificar la nueva columna 'treatment' seg칰n los valores de 'Treatment'
 micromammals_raw_data <- micromammals_raw_data %>%
   mutate(treatment = case_when(
     Treatment == "Control_A"      ~ "control_high",
     Treatment == "Control_B"      ~ "control_hyper",
     Treatment == "High_Density"   ~ "high",
     Treatment == "Hyper_Density"  ~ "hyper",
     Treatment == "Control"        ~ "control",
    TRUE ~ NA_character_  # Deja NA si no coincide con los valores dados
   )) %>%
   select(-Treatment)  # Eliminar la antigua columna 'Treatment'

# Modificar la nueva columna 'year' seg칰n los valores de 'Year'
 micromammals_raw_data <- micromammals_raw_data %>%
   mutate(year = case_when(
     Year == "2021"      ~ "2021",
     Year == "2022"      ~ "2022",
     TRUE ~ NA_character_  # Deja NA si no coincide con los valores dados
   )) %>%
   select(-Year)  # Eliminar la antigua columna 'Year'

# Modificar la nueva columna 'sampling_unit' seg칰n los valores de 'Trap'
 micromammals_raw_data <- micromammals_raw_data %>%
   mutate(sampling_unit = Trap
   ) %>%
   select(-Trap)  # Eliminar la antigua columna 'Trap'

 micromammals_raw_data <- micromammals_raw_data %>%
   mutate(sampling_unit = paste0("trap_", sampling_unit))

 # Asignar el valor "taxonomy" a toda la columna 'variable_type'
 micromammals_raw_data <- micromammals_raw_data %>%
   mutate(variable_type = "taxonomy")

 #Asignar el valor "micrommammal" a toda la columna 'variable_name'
 micromammals_raw_data <- micromammals_raw_data %>%
   mutate(variable_name = "micrommammal")

# Asignar el valor "n_individuals" a toda la columna 'units'
 micromammals_raw_data <- micromammals_raw_data %>%
   mutate(units = "n_individuals")


# Asegurarnos de que las columnas Apodemus y Sorex sean num칠ricas
 micromammals_raw_data <- micromammals_raw_data %>%
   mutate(
     Apodemus = as.numeric(Apodemus),
     Sorex = as.numeric(Sorex)
   )

 str (micromammals_raw_data)

# Pivotar las columnas Apodemus y Sorex
 micromammals_long <- micromammals_raw_data %>%
   pivot_longer(
     cols = c(Apodemus, Sorex),  # Las columnas de las especies
     names_to = "level",          # Esta ser치 la columna con el nombre de la especie
     values_to = "observation"    # Esta ser치 la columna con el n칰mero de individuos
   ) %>%
  # Reemplazar NA por 0 en observation para aquellos casos donde no haya capturado nada
   mutate(observation = replace_na(observation, 0))

# Cambiar los valores en 'level' y reordenar las columnas
 micromammals_long <- micromammals_long %>%
   # Cambiar los valores de 'level'
   mutate(level = case_when(
     level == "Apodemus" ~ "apodemus_sp",  # Reemplazar "Apodemus" por "apodemus_sp"
     level == "Sorex" ~ "sorex_sp",        # Reemplazar "Sorex" por "sorex_sp"
     TRUE ~ level                           # Mantener los dem치s valores igual
   )) %>%
   # Reordenar las columnas
   select(site, habitat, treatment, plot, sampling_unit, year, date, variable_type, variable_name, 
          level, observation, units, comments, author_code)

# Verificar la estructura del dataset y las primeras filas
# str(micromammals_long)
# head(micromammals_long)

```



## Clean data save micromam칤feros 游
```{r}
write.csv(micromammals_long, file = "/Users/jorgeislaescudero/Documents/GitHub/PAELLALAB/INCREMENTO/data_prepared/micrommals_clean_data.csv", row.names = FALSE)
```


# Esfuerzo de muestreo variable
```{r}
# Calcular el esfuerzo de muestreo (n칰mero de trampas por cada combinaci칩n de site, year y treatment)
micromammals_raw_data %>%
  group_by(site, year, treatment) %>%
  summarise(
    effort = n_distinct(sampling_unit),  # Contar las trampas 칰nicas
    .groups = "drop"
  ) %>%
  # Crear una tabla bonita con knitr::kable
  kable(
    caption = "Resumen del esfuerzo de muestreo por sitio, a침o y tratamiento",
    col.names = c("Sitio", "A침o", "Tratamiento", "N칰mero de trampas")
  )

```
Limpio el espacio
```{r}
# Elimina todos los objetos del entorno
rm(list = ls())

# Limpia la memoria RAM
gc()

# Opcional: limpia la consola (solo en RStudio)
cat("\014")
```
